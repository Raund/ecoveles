(function(b){function a(a,k,c,f){f={data:f||(k?k.data:{}),_wrap:k?k._wrap:null,tmpl:null,parent:k||null,nodes:[],calls:l,nest:x,wrap:p,html:y,update:z};a&&b.extend(f,a,{nodes:[],parent:k});c&&(f.tmpl=c,f._ctnt=f._ctnt||f.tmpl(b,f),f.key=++q,(t.length?r:m)[q]=f);return f}function d(a,k,e){var f,e=e?b.map(e,function(b){return"string"===typeof b?a.key?b.replace(/(<\w+)(?=[\s>])(?![^>]*_tmplitem)([^>]*)/g,"$1 "+o+'="'+a.key+'" $2'):b:d(b,a,b._ctnt)}):a;if(k)return e;e=e.join("");e.replace(/^\s*([^<\s][^<]*)?(<[\w\W]+>)([^>]*[^>\s])?\s*$/,
function(a,k,j,d){f=b(j).get();h(f);k&&(f=c(k).concat(f));d&&(f=f.concat(c(d)))});return f?f:c(e)}function c(a){var k=document.createElement("div");k.innerHTML=a;return b.makeArray(k.childNodes)}function e(a){return new Function("jQuery","$item","var $=jQuery,call,_=[],$data=$item.data;with($data){_.push('"+b.trim(a).replace(/([\\'])/g,"\\$1").replace(/[\r\t\n]/g," ").replace(/\$\{([^\}]*)\}/g,"{{= $1}}").replace(/\{\{(\/?)(\w+|.)(?:\(((?:[^\}]|\}(?!\}))*?)?\))?(?:\s+(.*?)?)?(\(((?:[^\}]|\}(?!\}))*?)\))?\s*\}\}/g,
function(a,j,f,c,d,e,h){a=b.tmpl.tag[f];if(!a)throw"Template command not found: "+f;f=a._default||[];e&&!/\w$/.test(d)&&(d+=e,e="");d?(d=g(d),h=h?","+g(h)+")":e?")":"",h=e?-1<d.indexOf(".")?d+e:"("+d+").call($item"+h:d,e=e?h:"(typeof("+d+")==='function'?("+d+").call($item):("+d+"))"):e=h=f.$1||"null";c=g(c);return"');"+a[j?"close":"open"].split("$notnull_1").join(d?"typeof("+d+")!=='undefined' && ("+d+")!=null":"true").split("$1a").join(e).split("$1").join(h).split("$2").join(c?c.replace(/\s*([^\(]+)\s*(\((.*?)\))?/g,
function(a,b,d,j){return(j=j?","+j+")":d?")":"")?"("+b+").call($item"+j:a}):f.$2||"")+"_.push('"})+"');}return _;")}function i(a,k){a._wrap=d(a,!0,b.isArray(k)?k:[u.test(k)?k:b(k).html()]).join("")}function g(a){return a?a.replace(/\\'/g,"'").replace(/\\\\/g,"\\"):null}function h(d){function k(d){function k(b){b+=e;j=h[b]=h[b]||a(j,m[j.parent.key+e]||j.parent,null,!0)}var f,c=d,j,g;if(g=d.getAttribute(o)){for(;c.parentNode&&1===(c=c.parentNode).nodeType&&!(f=c.getAttribute(o)););if(f!==g){c=c.parentNode?
11===c.nodeType?0:c.getAttribute(o)||0:0;if(!(j=m[g]))j=r[g],j=a(j,m[c]||r[c],null,!0),j.key=++q,m[q]=j;n&&k(g)}d.removeAttribute(o)}else if(n&&(j=b.data(d,"tmplItem")))k(j.key),m[j.key]=j,c=(c=b.data(d.parentNode,"tmplItem"))?c.key:0;if(j){for(f=j;f&&f.key!=c;)f.nodes.push(d),f=f.parent;delete j._ctnt;delete j._wrap;b.data(d,"tmplItem",j)}}var e="_"+n,f,c,h={},g,i,l;g=0;for(i=d.length;g<i;g++)if(1===(f=d[g]).nodeType){c=f.getElementsByTagName("*");for(l=c.length-1;0<=l;l--)k(c[l]);k(f)}}function l(a,
b,d,c){if(!a)return t.pop();t.push({_:a,tmpl:b,item:this,data:d,options:c})}function x(a,d,c){return b.tmpl(b.template(a),d,c,this)}function p(a,d){var c=a.options||{};c.wrapped=d;return b.tmpl(b.template(a.tmpl),a.data,c,a.item)}function y(a,d){var c=this._wrap;return b.map(b(b.isArray(c)?c.join(""):c).filter(a||"*"),function(a){if(d)a=a.innerText||a.textContent;else{var b;if(!(b=a.outerHTML))b=document.createElement("div"),b.appendChild(a.cloneNode(!0)),b=b.innerHTML;a=b}return a})}function z(){var a=
this.nodes;b.tmpl(null,null,null,this).insertBefore(a[0]);b(a).remove()}var v=b.fn.domManip,o="_tmplitem",u=/^[^<]*(<[\w\W]+>)[^>]*$|\{\{\! /,m={},r={},s,w={key:0,data:{}},q=0,n=0,t=[];b.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,d){b.fn[a]=function(c){var e=[],c=b(c),g,h,i;g=1===this.length&&this[0].parentNode;s=m||{};if(g&&11===g.nodeType&&1===g.childNodes.length&&1===c.length)c[d](this[0]),e=this;else{h=0;for(i=c.length;h<
i;h++)n=h,g=(0<h?this.clone(!0):this).get(),b.fn[d].apply(b(c[h]),g),e=e.concat(g);n=0;e=this.pushStack(e,a,c.selector)}c=s;s=null;b.tmpl.complete(c);return e}});b.fn.extend({tmpl:function(a,c,d){return b.tmpl(this[0],a,c,d)},tmplItem:function(){return b.tmplItem(this[0])},template:function(a){return b.template(a,this[0])},domManip:function(a,c,d){if(a[0]&&a[0].nodeType){for(var e=b.makeArray(arguments),g=a.length,h=0,i;h<g&&!(i=b.data(a[h++],"tmplItem")););1<g&&(e[0]=[b.makeArray(a)]);i&&n&&(e[2]=
function(a){b.tmpl.afterManip(this,a,d)});v.apply(this,e)}else v.apply(this,arguments);n=0;!s&&b.tmpl.complete(m);return this}});b.extend({tmpl:function(c,e,g,f){var h=!f;if(h)f=w,c=b.template[c]||b.template(null,c),r={};else if(!c)return c=f.tmpl,m[f.key]=f,f.nodes=[],f.wrapped&&i(f,f.wrapped),b(d(f,null,f.tmpl(b,f)));if(!c)return[];"function"===typeof e&&(e=e.call(f||{}));g&&g.wrapped&&i(g,g.wrapped);e=b.isArray(e)?b.map(e,function(b){return b?a(g,f,c,b):null}):[a(g,f,c,e)];return h?b(d(f,null,
e)):e},tmplItem:function(a){var c;for(a instanceof b&&(a=a[0]);a&&1===a.nodeType&&!(c=b.data(a,"tmplItem"))&&(a=a.parentNode););return c||w},template:function(a,c){return c?("string"===typeof c?c=e(c):c instanceof b&&(c=c[0]||{}),c.nodeType&&(c=b.data(c,"tmpl")||b.data(c,"tmpl",e(c.innerHTML))),"string"===typeof a?b.template[a]=c:c):a?"string"!==typeof a?b.template(null,a):b.template[a]||b.template(null,u.test(a)?a:b(a)):null},encode:function(a){return(""+a).split("<").join("&lt;").split(">").join("&gt;").split('"').join("&#34;").split("'").join("&#39;")}});
b.extend(b.tmpl,{tag:{tmpl:{_default:{$2:"null"},open:"if($notnull_1){_=_.concat($item.nest($1,$2));}"},wrap:{_default:{$2:"null"},open:"$item.calls(_,$1,$2);_=[];",close:"call=$item.calls();_=call._.concat($item.wrap(call,_));"},each:{_default:{$2:"$index, $value"},open:"if($notnull_1){$.each($1a,function($2){with(this){",close:"}});}"},"if":{open:"if(($notnull_1) && $1a){",close:"}"},"else":{_default:{$1:"true"},open:"}else if(($notnull_1) && $1a){"},html:{open:"if($notnull_1){_.push($1a);}"},"=":{_default:{$1:"$data"},
open:"if($notnull_1){_.push($.encode($1a));}"},"!":{open:""}},complete:function(){m={}},afterManip:function(a,c,d){var e=11===c.nodeType?b.makeArray(c.childNodes):1===c.nodeType?[c]:[];d.call(a,c);h(e);n++}})})(jQuery);var translate={};String.prototype.translate=function(){return translate[this]?translate[this]:this};
(function(){var b=this.console,a=this.console={};a.production=!1;b&&!b.time&&(b.time=function(c,b){if(c){var d=(new Date).getTime();a.timeCounters||(a.timeCounters={});var h="KEY"+c.toString();if(b||!a.timeCounters[h])a.timeCounters[h]=d}},b.timeEnd=function(c){var b=(new Date).getTime();if(!a.timeCounters)return null;var d="KEY"+c.toString(),h=a.timeCounters[d];if(h){var l=b-h;a.info(c+": "+l+"ms");delete a.timeCounters[d]}return l});for(var d="assert count debug dir dirxml error group groupCollapsed groupEnd info log markTimeline profile profileEnd table time timeEnd trace warn".split(" "),
c=d.length;c--;)(function(c){a[c]=function(){if(b&&c in b&&!a.production)try{b[c].apply(b,arguments)}catch(d){alert(arguments)}}})(d[c])})();
(function(b){b.installer={options:{redirect_url:null,redirect_timeout:3E3,updateStateInterval:2E3,updateStateErrorInterval:6E3,queue:[],install:!1,logMode:"raw",timestamp:null,end:null},timeout:{state:null},counter:0,offset:0,complete:null,thread_id:null,init:function(a,d){this.trace("init");this.thread_id=d||null;this.options=b.extend({},this.options,a||{});this.options.timestamp&&(this.offset=(new Date).getTime()/1E3-parseInt(this.options.timestamp),10<Math.abs(this.offset)&&console.error("Invalid timestamp at response, check server time",
this.offset));var c=this;this.helper.compileTemplates();this.options.queue.length?this.execute("update",this.options.queue):this.execute("state",null);b("body").addClass("i-fixed-body");this.onResize();b(window).resize(function(){c.onResize()})},helper:{plural:function(a){return 1==a%10&&11!=a%100?0:2<=a%10&&4>=a%10&&(10>a%100||20<=a%100)?1:2},compileTemplates:function(){var a=/<\\\/(\w+)/g;b("script[type$='x-jquery-tmpl']").each(function(){try{var d=b(this).attr("id").replace(/-template-js$/,"");
b.installer.trace("Compile template",d);b.template(d,b(this).html().replace(a,"</$1"))}catch(c){console.error(c)}})},subject:function(a){var b,c="generic";a.match(/^wa-apps/)?c=(b=a.match(/^wa-apps\/\w+\/(\w+)/))?"app_"+b[1]:"apps":a.match(/^wa-plugins/)&&(c=(b=a.match(/^wa-plugins\/\w+\/(\w+)/))?"systemplugins_"+b[1]:"systemplugins");return c}},onResize:function(){setInterval(function(){b(".content .i-app-update-screen").css("max-height",parseInt(b("#wa").css("height"))-110+"px")},500)},execute:function(a,
b){a=a||"default";this.trace("execute action "+a,b);if(this[a+"Action"]){this.currentAction=a;this.currentActionAttr=b;try{return this[a+"Action"](b)}catch(c){console.error("Exception while execute "+a+"Action",c)}}else console.error("Invalid action name",a+"Action");return null},defaultAction:function(){},stateAction:function(){var a=this;try{this.sendRequest("?module=update&action=state",{mode:this.options.logMode},function(c){a.updateStateHandler(c)},function(c){a.updateStateErrorHandler(c)})}catch(b){console.error("Exception while execute stateAction",
b),this.execute("state",null)}},updateAction:function(a){var d=this;this.sendRequest("?module=update&action=execute",{thread_id:this.thread_id,app_id:a,mode:this.options.logMode,install:this.options.install?"1":"0"},function(a){try{d.updateExecuteHandler(a)}catch(b){console.error("Exception while execute updateExecuteHandler",b)}},function(a){try{d.updateExecuteErrorHandler(a)}catch(b){console.error("Exception while execute updateExecuteErrorHandler",b)}},function(){d.timeout.state=setTimeout(function(){d.execute("state",
null)},Math.max(2E3,4*d.options.updateStateInterval))});setTimeout(function(){b("#wa-app-installer span.indicator").remove();b("#wa-app li span.indicator").remove()},500)},updateExecuteHandler:function(a){this.trace("updateExecuteHandler",a);this.timeout.state&&clearTimeout(this.timeout.state);var d={success:0,success_plural:0,fail:0,fail_plural:0},c={},e=!1,i="generic";if(a){this.complete=!0;if(a.sources)for(var g in a.sources)a.sources.hasOwnProperty(g)&&(i=this.helper.subject(a.sources[g].target),
"generic"!=i&&(c[i]||(c[i]={success:0,fail:0,plural:null}),a.sources[g].skipped?(++d.fail,e=e||"no",++c[i].fail):(++d.success,e=e||"yes",++c[i].success)));d.success_plural=this.helper.plural(d.success);d.fail_plural=this.helper.plural(d.fail);var h=this;this.drawStateInfo(a.state,e||"no");setTimeout(function(){b.tmpl("application-update-result",{current_state:a.current_state,result:d,sources:a.sources}).appendTo("#update-raw");setTimeout(function(){var a=b("div.i-app-update-screen :last").offset().top;
b("div.i-app-update-screen").scrollTop(a);h.redirectOnComplete();h.animateOnInstall()},500)},500)}},updateExecuteErrorHandler:function(a){this.trace("updateExecuteErrorHandler",a)},updateStateHandler:function(a){this.trace("stateHandler",a);(this.timeout.state||this.complete)&&clearTimeout(this.timeout.state);var d=this;try{if(this.complete)this.redirectOnComplete();else{var c=!1,e=new Date,i=a.current_state?Math.abs(this.offset-(e.getTime()/1E3-parseInt(a.current_state.timestamp))):null;a.current_state&&
15>i&&("error"==a.current_state.stage_status?c=!0:"complete"==a.current_state.stage_status&&"update"==a.current_state.stage_name&&(c=!0));c?(this.drawStateInfo(a.state,"error"==a.current_state.stage_status?"no":"yes"),b.tmpl("application-update-result",{current_state:a.current_state,result:null}).appendTo("#update-raw")):a.current_state&&a.state&&15>i&&"none"!=a.current_state.stage_status?(this.drawStateInfo(a.state),this.timeout.state=setTimeout(function(){d.complete||d.execute("state",null)},this.options.updateStateInterval)):
this.timeout.state=setTimeout(function(){d.complete||d.execute("state",null)},this.options.updateStateErrorInterval)}}catch(g){this.timeout.state=setTimeout(function(){d.complete||d.execute("state",null)},this.options.updateStateErrorInterval),console.error("updateStateHandler error: "+g.message,g)}},updateStateErrorHandler:function(a){this.trace("StateErrorHandler",a);this.timeout.state&&clearTimeout(this.timeout.state);var b=this;this.timeout.state=setTimeout(function(){b.complete||b.execute("state",
null)},this.options.updateStateErrorInterval)},drawStateInfo:function(a,d){var c,e,d=d||"loading";switch(this.options.logMode){case "raw":if(a&&a.length){for(c in a)a.hasOwnProperty(c)&&!a[c].datetime&&(a[c].datetime=new Date(1E3*parseInt(a[c].stage_start_time)));e=b("#template-placeholder").html();try{b("#template-placeholder").empty(),b.tmpl("application-update-raw",{stages:a,apps:this.options.queue,state_class:d}).appendTo("#template-placeholder")}catch(i){console.error("Error while parse template ",
i),b("#template-placeholder").html(e)}}break;default:e=b("#template-placeholder").html();try{b("#template-placeholder").empty();for(var g in a)if(a.hasOwnProperty(g)){for(c in a[g])a[g].hasOwnProperty(c)&&!a[g][c].datetime&&(a[g][c].datetime=new Date(1E3*parseInt(a[g][c].stage_start_time)));var h=new Date(1E3*parseInt(a[g][1].stage_start_time));b.tmpl("application-update-apps",{slug:g,timestamp:h,stages:a[g],state_class:d}).appendTo("#template-placeholder")}}catch(l){console.error("Error while parse template ",
l),b("#template-placeholder").html(e)}}setTimeout(function(){var a=b("div.i-app-update-screen :last").offset().top;b("div.i-app-update-screen").scrollTop(a);b("#wa-app-installer span.indicator").remove();b("#wa-app li span.indicator").remove()},100)},redirectOnComplete:function(){if(this.options.redirect_url){var a=this;setTimeout(function(){window.location=a.options.redirect_url},this.options.redirect_timeout)}},animateOnInstall:function(){b("#update-result-apps li").each(function(){var a=b(this);
a.parent().show();var d=a.offset(),c=null,e=b("#wa-applist ul li[id^="+a.attr("id")+"]");e.length?c=e.offset():(c=b("#wa-applist ul li #wa-moreapps").offset(),c.left||(c=b("#wa-applist ul li[id^=wa-app-]:last").offset(),c.left+=75));var c={left:c.left,top:c.top},i={top:0,left:0,position:"relative",display:"inline-block"};a.css({top:d.top,left:d.left,position:"absolute",display:"inline-block"});a.animate(c,700,function(){a.css(i);e.length?e.replaceWith(a):a.appendTo("#wa-applist ul");b(window).resize()})})},
trace:function(){},sendRequest:function(a,d,c,e,i){var g=this;b.ajax({url:a+"&timestamp="+(new Date).getTime(),data:d,type:"GET",dataType:"json",success:function(a,d){try{try{"object"!=typeof a&&(a=b.parseJSON(a))}catch(i){throw console.error("Invalid server JSON response",i),"function"==typeof e&&e(),i;}if(a)switch(a.status){case "fail":g.displayMessage(a.errors.error||a.errors,"error");"function"==typeof e&&e(a);break;case "ok":"function"==typeof c&&c(a.data);break;default:console.error("unknown status response",
a.status),"function"==typeof e&&e(a)}else console.error("empty response",d),"function"==typeof e&&e(),g.displayMessage("Empty server response","warning")}catch(p){console.error("Error handling server response ",p),"function"==typeof e&&e(a),g.displayMessage("Invalid server response<br>"+p.description,"error")}},error:function(a,b,c){console.error("AJAX request error",[b,c]);"function"==typeof e&&e();g.displayMessage("AJAX request error","warning")},beforeSend:i})},displayMessage:function(){}}})(jQuery);
